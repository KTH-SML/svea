#! /bin/sh
#
# Build the image for this workspace
#
# Author: Kaj Munhoz Arfvidsson

## To build cross-platform,
##   1. use relevant CONFIG (see util/config.sh),
##   2. your host computer must have QEMU:
##      > sudo apt-get install qemu-user-static
##      > docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
##      > docker buildx create --use

. "$(dirname "$0")/config.sh"

# Set default arguments, create and set list content
append DEFAULT_ARGS "$(ifelse IMAGE_PUSH --push --load)"
append DEFAULT_ARGS --tag "$IMAGE_TAG" --file "$BUILD_FILE" "$BUILD_CONTEXT"

if [ -z "$*" ]; then
    set -- $DEFAULT_ARGS
fi

istrue DEBUG && fn="echo" || fn="exec"

"$fn" docker buildx build \
    --network host \
    --platform "$BUILD_PLATFORM" \
    --build-arg "BUILD_TAG=$BUILD_TAG" \
    --build-arg "ROSDISTRO=$ROSDISTRO" \
    --build-arg "WORKSPACE=$WORKSPACE" \
    "$@"
